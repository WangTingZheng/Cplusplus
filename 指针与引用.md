# 指针与引用

## 指针
变量实际上是对寄存器的一种封装，它在编程语言层级屏蔽了底层硬件的细节，使得你可以通过读写变量来读取计算机内部保存的数据，但是变量有因为无法直接访问到内存地址，所以存在以下几个问题：
1. 无法进行浅拷贝，
2. 无法直接操作硬件
3. 无法匹配未知类型的变量


### 无法进行浅拷贝
当我们要把一个变量拷贝到另外一个变量时，我们必须把它里的内存资源拷贝一份赋值到新变量中，哪怕原变量已经不用了，因为我们并不能取得它的内存地址

### 无法直接操作硬件
因为所有的硬件设备并不一定都会提供一个封装好的库供用户调用，很多时候，硬件厂商只会发布一个文档，里面写着它的设备的输入输出的地址，如果C++只有变量，就没办法访问到这些没有驱动的硬件，也就没办法作为一门硬件级别的编程语言存在了

### 无法匹配未知类型的变量
很多时候，我们并不知道函数要处理的值是什么类型的，比如说LevelDB的cache可以缓存任意类型的value，在插入这个value前，我们也需要传入释放这个value的函数，这个函数的参数是写死的，类型必须确定，但是我们并不知道插入时，value的类型是什么，如果只有变量的话，这个函数就很难写，因为变量总是有固定的变量类型，如果传入的不是这个变量类型的value，就无法匹配到这个函数。

### 用变量指挥机器

我们可以看到，变量的问题的根本原因在于，变量是编程语言级别的封装，使用它的程序员就好比黑客帝国中，生活在matrix中的人类，不能进行浅拷贝是因为我们不能直接传递数据的内存地址，因为我们访问不到，不能对硬件编程是也是因为我们不能直接在内存上进行读写，只能通过变量或者操作系统来读写，这个时候读写在哪块内存里就由不得你了。之所以没有办法创造出一个匹配任何变量的函数，是因为即使是同一块内存区域，只要表示为不同变量，它们就是不同的。

基于以上的原因，C++选择重新回到机器，创造出指针这个机制。

#### 用指针实现浅拷贝
指针这个机制可以使得程序员通过C++直接存储、读写内存地址，所以拷贝一个变量，我们就可以直接拷贝它的内存地址，这个时候拷贝的开销实际上就是拷贝地址的开销，这个开销是可以小到可以忽略的。


#### 用指针操作硬件
因为我们可以直接读写内存，所以我们可以根据硬件厂商提供的输入输出的硬件地址对硬件进行编程，使用C++封装成一套API接口供其它人使用，使得C++成为一种可以面向机器的语言。


#### 用void指针匹配未知的变量指针
通过指针，我们可以定义void*变量，因为在硬件眼里，不管内存里存储的是什么值，只要内存地址一样，它就是一样的，类型可以转，所以我们可以把普通类型的value转换为void类型的value传入LevelDB的cache，就可以实现使用Cache存储所有类型的value了，指针使得C++可以有一种透视的视角，类似黑客帝国中失明的主角。

### 总结
从具体实现上来说，我们复用了C++中的变量，我们定义一种特殊的变量，这些变量可以保存其它变量的地址，这种变量就叫做指针。所以指针也是变量，既然是变量，就有内存地址，我们就可以用另外一个指针去指向它的地址，所以指针有多级，比如说int**这种的。

## 引用
但是指针也存在问题，因为可以对内存直接进行读写，所以指针也非常危险，它主要存在以下问题：
1. 未人为初始化时，可能指向一个没有意义的内存地址，读写这个地址可能造成不可意料的危险，可能会修改其它变量的值，可能会修改操作系统的内存数据
2. 指针解引用需要用一个符号*，这样看起来不是很简洁，尤其是和乘法运算符*混用的时候
3. 指针所指向的地址可以更换，容易出错

针对以上问题，C++创造了引用，引用实际上就是指针，比如说：

```C++
void swap(int *a, int *b){
    int tmp = *a;
    *a = *b;
    *b = tmp;
}
```

```C++
void swap(int &a, int &b){
    int tmp = a;
    a = b;
    b = tmp;
}
```
它们在汇编级别上是完全一样的，但是引用又和指针有所不同，它在语法上进行了一些限制：
1. 引用不能让程序员直接操作内存
2. 引用一旦创建了，就必须初始化，不初始化就会报错，这就避免了指针初始化成一个无意义的地址的问题
3. 引用一旦绑定了一个变量，就不能更换，对这个变量终身负责，这就避免了指针频繁更换地址，容易出错的问题

值得注意的是，引用更像是一种编译器的概念，它是对指针的一种封装，可以理解成，编译器会把带有引用的代码先翻译成所绑定的对象的指针，再翻译成机器码，类似与define？所以引用本身不是对象，因为可能会直接被替换掉，所以没有多级引用，因为不管是引用还是指针，都必须指向的是有实体的变量。